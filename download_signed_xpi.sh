#!/usr/bin/env bash
#
# Usage: sign_xpi.sh -t <token> -i <addon-id> -v <version>
#
#          -t : JWT token generated by get_token.sh, like: "ABCD..."
#          -i : Addon ID, like: "myaddon@example.com"
#          -v : Version, like: "1.1"
#
# See also: https://blog.mozilla.org/addons/2015/11/20/signing-api-now-available/

case $(uname) in
  Darwin|*BSD|CYGWIN*) sed="sed -E" ;;
  *)                   sed="sed -r" ;;
esac

while getopts t:i:v: OPT
do
  case $OPT in
    "t" ) token="$OPTARG" ;;
    "i" ) id="$OPTARG" ;;
    "v" ) version="$OPTARG" ;;
  esac
done

[ "$token" = "" ] && echo 'You must specify a JWT token via "-t"' && exit 1
[ "$i" = "" ] && echo 'You must specify the addon ID via "-i"' && exit 1
[ "$v" = "" ] && echo 'You must specify the addon ID via "-v"' && exit 1

response=$(curl "https://addons.mozilla.org/api/v3/addons/$id/versions/$version/" \
             -H "Authorization: JWT $token")

if echo "$response" | grep -E '"signed"\s*:\s*true'
then
  uri=$(echo "$response" | $sed -e 's/.+"download_url"\s*:\s*"([^"]+).+/\1/')
  curl "$uri" -o "$id-$version-signed.xpi"
  exit 0
else
  echo "Not signed yet." 1>&2
  exit 1
fi

